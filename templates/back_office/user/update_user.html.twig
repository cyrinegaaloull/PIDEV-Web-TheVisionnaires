{% extends 'back_office/base-back-office.html.twig' %}

{% block title %}Update User{% endblock %}

{% block body %}
<div class="row">
  <!-- Flash Messages -->
  {% for label, messages in app.flashes %}
    {% for message in messages %}
      <div class="alert alert-{{ label }} alert-dismissible mb-3" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endfor %}

  <!-- Update User Form -->
  <div class="col-xl-8">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Update User</h5>
        <small class="text-body float-end">User Management</small>
      </div>
      <div class="card-body">
        <form action="{{ path('update_user', {'id': user.userId}) }}" method="post" enctype="multipart/form-data">
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="form-floating form-floating-outline mb-4">
                <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}" placeholder="Username" required />
                <label for="username">Username</label>
                {% if usernameError is defined and usernameError %}
                  <div class="text-danger">{{ usernameError }}</div>
                {% endif %}
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-floating form-floating-outline mb-4">
                <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" placeholder="Email" required />
                <label for="email">Email</label>
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <div class="form-floating form-floating-outline mb-4">
                <input type="password" class="form-control" id="password" name="password" value="{{ user.password }}" placeholder="Password" required />
                <label for="password">Password</label>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-floating form-floating-outline mb-4">
                <input type="password" class="form-control" id="confirm_password" name="confirm_password" placeholder="Confirm Password" required />
                <label for="confirm_password">Confirm Password</label>
                {% if passwordError is defined and passwordError %}
                  <div class="text-danger">{{ passwordError }}</div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <div class="form-floating form-floating-outline mb-4">
                <input type="text" class="form-control" id="nom" name="nom" value="{{ user.nom }}" placeholder="Nom" required />
                <label for="nom">Nom</label>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="form-floating form-floating-outline mb-4">
                <input type="text" class="form-control" id="prenom" name="prenom" value="{{ user.prenom }}" placeholder="Prenom" required />
                <label for="prenom">Prenom</label>
              </div>
            </div>
          </div>

          <div class="mb-4">
            <label for="avatar" class="form-label">Avatar</label>
            <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*" />
            {% if user.avatar %}
              <div class="mt-3">
                <p class="mb-2">Current Avatar:</p>
                <img src="{{ asset(user.avatar) }}" alt="Current Avatar" class="img-thumbnail" style="max-width: 150px;">
              </div>
            {% endif %}
          </div>

          <div class="form-floating form-floating-outline mb-4">
            <select class="form-select" id="role_id" name="role_id" required>
              <option value="">-- Select a Role --</option>
              {% for role in roles %}
                <option value="{{ role.id }}" {% if user.role and user.role.id == role.id %}selected{% endif %}>
                  {{ role.role }}
                </option>
              {% endfor %}
            </select>
            <label for="role_id">Role</label>
          </div>
          
          <input type="hidden" name="_token" value="{{ csrf_token('update_user' ~ user.userId) }}">
          
          <div class="d-flex">
            <button type="submit" class="btn btn-primary me-3">Update User</button>
            <a href="{{ path('list_users') }}" class="btn btn-outline-secondary">
              Back to List
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- User Information Card -->
  <div class="col-xl-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">User Information</h5>
      </div>
      <div class="card-body">
        <p>Update user information including personal details, authentication credentials, and system role. All fields are required except the avatar upload.</p>
        <p class="mb-0">If you don't want to change the password, please re-enter the current one.</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Password confirmation validation
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    
    if (passwordInput && confirmPasswordInput) {
      confirmPasswordInput.addEventListener('input', function() {
        if (passwordInput.value !== confirmPasswordInput.value) {
          confirmPasswordInput.setCustomValidity("Passwords don't match");
        } else {
          confirmPasswordInput.setCustomValidity('');
        }
      });
      
      passwordInput.addEventListener('input', function() {
        if (passwordInput.value !== confirmPasswordInput.value) {
          confirmPasswordInput.setCustomValidity("Passwords don't match");
        } else {
          confirmPasswordInput.setCustomValidity('');
        }
      });
    }
  });
</script>
{% endblock %}