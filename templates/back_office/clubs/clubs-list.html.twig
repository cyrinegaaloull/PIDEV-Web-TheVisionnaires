{% extends 'back_office/base-back-office.html.twig' %}

{% block body %}
<div class="card p-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0">Liste des clubs</h5>
  <div>
    <a href="{{ path('admin_club_export') }}" class="btn btn-outline-success me-2" title="Exporter en CSV">
      <i class="ri-file-excel-2-line me-1"></i> Exporter
    </a>
    <a href="{{ path('admin_club_new') }}" class="btn btn-primary">
      <i class="ri-add-line me-1"></i> Nouveau Club
    </a>
  </div>
</div>

  <div class="row mb-3">
    <div class="col-md-6">
      <input type="text" id="search-input" class="form-control" placeholder="Rechercher un club...">
    </div>
    <div class="col-md-3">
      <select id="filter-select" class="form-select">
        <option value="">Filtrer par</option>
        <option value="az">A → Z</option>
        <option value="za">Z → A</option>
        <option value="oldest">Plus ancien</option>
        <option value="newest">Plus récent</option>
      </select>
    </div>
  </div>

  <div id="clubs-table-container">
    {% include 'back_office/clubs/_clubs_table.html.twig' with {'clubs': clubs} %}
  </div>

  <div class="d-flex justify-content-between align-items-center mt-3">
  <div>
    Total : {{ totalClubs }} clubs
  </div>
</div>
</div>


<script>
  function fetchClubs(page = 1) {
    const search = document.getElementById('search-input').value;
    const filter = document.getElementById('filter-select').value;

    const url = new URL("{{ path('admin_club_list') }}", window.location.origin);
    url.searchParams.append('page', page);
    if (search) url.searchParams.append('search', search);
    if (filter) url.searchParams.append('filter', filter);

    fetch(url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(res => res.text())
    .then(html => {
      document.getElementById('clubs-table-container').innerHTML = html;
    });
  }

  // Search & Filter events
  document.getElementById('search-input').addEventListener('input', () => fetchClubs(1));
  document.getElementById('filter-select').addEventListener('change', () => fetchClubs(1));

  // AJAX pagination
 document.addEventListener('click', function (e) {
  if (e.target.classList.contains('page-link-ajax')) {
    e.preventDefault();
    const page = e.target.dataset.page;

    const search = document.getElementById('search-input').value;
    const filter = document.getElementById('filter-select').value;

    fetch(`{{ path('admin_club_list') }}?search=${search}&filter=${filter}&page=${page}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(res => res.text())
    .then(html => {
      document.getElementById('clubs-table-container').innerHTML = html;
    });
  }
});

// Delete button handling
document.addEventListener('click', function(e) {
    // Handle delete button click
    if (e.target.closest('.btn-delete')) {
        e.preventDefault();
        const deleteUrl = e.target.closest('.btn-delete').getAttribute('data-url');
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        
        // Set up confirm button
        document.getElementById('confirm-delete-btn').onclick = function() {
            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    '_token': '{{ csrf_token('delete') }}'
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Network response was not ok');
            })
            .then(data => {
                if (data.success) {
                    modal.hide();
                    fetchClubs(1); // Refresh the list
                } else {
                    alert('Error: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting');
            });
        };
        
        modal.show();
    }
});
</script>
<style>
.pagination-rounded .page-link {
  border-radius: 1.5rem !important;
}
.btn-circle {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: 50% !important;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

</style>
{% endblock %}
