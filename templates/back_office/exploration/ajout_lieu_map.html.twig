{% extends 'back_office/base-back-office.html.twig' %}

{% block body %}
<h4>Étape 1 : Sélectionnez un lieu sur la carte</h4>

<div class="mb-3">
  <input type="text" id="searchInput" class="form-control" placeholder="Rechercher un lieu (ex: Paris)">
  <ul id="suggestions" class="list-group mt-2"></ul>
</div>

<div id="map" style="height: 500px; border-radius: 12px;"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([36.8065, 10.1815], 6); // Tunisia center
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  let marker;

  document.getElementById('map').addEventListener('click', function (e) {
    map.on('click', function (ev) {
      const { lat, lng } = ev.latlng;
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);

      alert("Lieu sélectionné !");
      window.location.href = `/admin/lieu/complete/${lat}/${lng}/Inconnu`;
    });
  });

  // Photon Search
  const input = document.getElementById('searchInput');
  const suggestions = document.getElementById('suggestions');
  input.addEventListener('input', function () {
    const query = input.value.trim();
    if (!query) return;
    fetch(`https://photon.komoot.io/api/?q=${query}&limit=5`)
      .then(res => res.json())
      .then(data => {
        suggestions.innerHTML = '';
        data.features.forEach(feature => {
          const li = document.createElement('li');
          li.className = 'list-group-item list-group-item-action';
          li.textContent = feature.properties.name + ' - ' + (feature.properties.city || '');
          li.onclick = () => {
            const [lon, lat] = feature.geometry.coordinates;
            map.setView([lat, lon], 14);
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lon]).addTo(map);
            const name = feature.properties.name + 
             (feature.properties.city ? `, ${feature.properties.city}` : '') + 
             (feature.properties.country ? `, ${feature.properties.country}` : '');
window.location.href = `/admin/lieu/complete/${lat}/${lon}/${encodeURIComponent(name)}`;

          };
          suggestions.appendChild(li);
        });
      });
  });
</script>
{% endblock %}
